CREATE TABLE schools (
	id INTEGER NOT NULL, 
	name VARCHAR(255) NOT NULL, code VARCHAR(64), description TEXT, contact_email VARCHAR(255), contact_phone VARCHAR(64), address VARCHAR(255), city VARCHAR(128), state VARCHAR(64), 
	PRIMARY KEY (id), 
	UNIQUE (name)
);
CREATE INDEX ix_schools_id ON schools (id);
CREATE TABLE users (
	id VARCHAR(36) NOT NULL, 
	email VARCHAR(255) NOT NULL, 
	full_name VARCHAR(255) NOT NULL, 
	role VARCHAR(32) NOT NULL, 
	school_id INTEGER, 
	hashed_password VARCHAR(255) NOT NULL, 
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL, classroom_id INTEGER, subject_id INTEGER, 
	PRIMARY KEY (id), 
	FOREIGN KEY(school_id) REFERENCES schools (id)
);
CREATE UNIQUE INDEX ix_users_email ON users (email);
CREATE INDEX ix_users_id ON users (id);
CREATE TABLE classrooms (
	id INTEGER NOT NULL, 
	name VARCHAR(255) NOT NULL, 
	school_id INTEGER NOT NULL, code VARCHAR(64), subject_id INTEGER, grade_level VARCHAR(64), 
	PRIMARY KEY (id), 
	FOREIGN KEY(school_id) REFERENCES schools (id)
);
CREATE INDEX ix_classrooms_id ON classrooms (id);
CREATE TABLE subjects (
	id INTEGER NOT NULL, 
	name VARCHAR(255) NOT NULL, 
	school_id INTEGER NOT NULL, code VARCHAR(64), teacher_id VARCHAR(36), color VARCHAR(16), description TEXT, 
	PRIMARY KEY (id), 
	FOREIGN KEY(school_id) REFERENCES schools (id)
);
CREATE INDEX ix_subjects_id ON subjects (id);
CREATE UNIQUE INDEX uq_schools_code ON schools(code) WHERE code IS NOT NULL;
CREATE UNIQUE INDEX uq_subjects_school_code ON subjects(school_id, code) WHERE code IS NOT NULL;
CREATE UNIQUE INDEX uq_classrooms_school_code ON classrooms(school_id, code) WHERE code IS NOT NULL;
CREATE TABLE classroom_subjects (
	classroom_id INTEGER NOT NULL, 
	subject_id INTEGER NOT NULL, 
	PRIMARY KEY (classroom_id, subject_id), 
	FOREIGN KEY(classroom_id) REFERENCES classrooms (id), 
	FOREIGN KEY(subject_id) REFERENCES subjects (id)
);
CREATE INDEX ix_subjects_teacher_id ON subjects(teacher_id);
CREATE TABLE trigger_keywords (
	id INTEGER NOT NULL, 
	keyword VARCHAR(128) NOT NULL, 
	school_id INTEGER, 
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	PRIMARY KEY (id), 
	CONSTRAINT uq_trigger_keywords_scope UNIQUE (keyword, school_id), 
	FOREIGN KEY(school_id) REFERENCES schools (id)
);
CREATE INDEX ix_trigger_keywords_id ON trigger_keywords (id);
CREATE UNIQUE INDEX uq_trigger_keywords_scope ON trigger_keywords(keyword, school_id);
CREATE TABLE IF NOT EXISTS "feedbacks" (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        sender_id VARCHAR(36) NOT NULL,
                        target_type VARCHAR(16) NOT NULL,
                        target_id VARCHAR(64) NOT NULL,
                        content_encrypted TEXT NOT NULL,
                        nonce VARCHAR(255) NOT NULL,
                        sentiment VARCHAR(32),
                        category VARCHAR(64),
                        has_trigger BOOLEAN NOT NULL DEFAULT 0,
                        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                        sentiment_label VARCHAR(32),
                        sentiment_score FLOAT,
                        manual_trigger_reason TEXT,
                        manual_triggered_by VARCHAR(36),
                        trigger_resolved_at TIMESTAMP,
                        trigger_resolved_by VARCHAR(36),
                        trigger_resolved_note VARCHAR(255),
                        FOREIGN KEY(sender_id) REFERENCES users(id) ON DELETE CASCADE,
                        FOREIGN KEY(manual_triggered_by) REFERENCES users(id) ON DELETE SET NULL,
                        FOREIGN KEY(trigger_resolved_by) REFERENCES users(id) ON DELETE SET NULL
                    );
CREATE TABLE sqlite_sequence(name,seq);
CREATE INDEX ix_feedback_target ON feedbacks (target_type, target_id);
CREATE INDEX ix_feedback_created_at ON feedbacks (created_at);
CREATE INDEX ix_feedbacks_id ON feedbacks (id);
CREATE TABLE teacher_subjects (
	teacher_id VARCHAR(36) NOT NULL, 
	subject_id INTEGER NOT NULL, 
	PRIMARY KEY (teacher_id, subject_id), 
	FOREIGN KEY(teacher_id) REFERENCES users (id) ON DELETE CASCADE, 
	FOREIGN KEY(subject_id) REFERENCES subjects (id) ON DELETE CASCADE
);
CREATE TABLE teacher_assignments (
	id INTEGER NOT NULL, 
	classroom_id INTEGER NOT NULL, 
	subject_id INTEGER NOT NULL, 
	teacher_id VARCHAR(36) NOT NULL, 
	created_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	updated_at DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	PRIMARY KEY (id), 
	CONSTRAINT uq_teacher_assignment_scope UNIQUE (classroom_id, subject_id), 
	FOREIGN KEY(classroom_id) REFERENCES classrooms (id) ON DELETE CASCADE, 
	FOREIGN KEY(subject_id) REFERENCES subjects (id) ON DELETE CASCADE, 
	FOREIGN KEY(teacher_id) REFERENCES users (id) ON DELETE CASCADE
);
CREATE INDEX ix_teacher_assignments_teacher_id ON teacher_assignments (teacher_id);
CREATE INDEX ix_teacher_assignments_classroom_id ON teacher_assignments (classroom_id);
CREATE INDEX ix_teacher_assignments_subject_id ON teacher_assignments (subject_id);
CREATE INDEX ix_teacher_assignments_id ON teacher_assignments (id);
